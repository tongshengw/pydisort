name: Packaging Tests
on:
  push:
    # Run on tags that look like releases
    tags:
      - v*
  workflow_dispatch:
    inputs:
      incoming_ref:
        description: 'The ref to checkout before running the workflow'
        required: true
        default: 'main'
      upload_to_pypi:
        description: 'Whether to upload to PyPI'
        required: true
        default: 'false'

jobs:
  macos-arm-wheel:
    name: Build macOS arm64 wheels
    runs-on: macos-latest
    outputs:
      job-status: ${{ job.status }}

    strategy:
      matrix:
        py: ["38", "39", "310", "311", "312"]
        deployment_target: ["11.0"]
      fail-fast: true

    env:
      MACOSX_DEPLOYMENT_TARGET: ${{ matrix.deployment_target }}

    steps:
      - uses: actions/checkout@v3
        name: Checkout the repository
        with:
          ref: ${{ github.event.inputs.incoming_ref }}

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.16.2
        env:
          CIBW_ARCHS_MACOS: arm64
          CIBW_BUILD: cp${{ matrix.py }}-*
          CIBW_ENVIRONMENT: "WORKSPACE=${{ github.workspace }}"

      - name: Archive the built wheels
        uses: actions/upload-artifact@v4
        with:
          path: ./wheelhouse/*.whl
          name: wheels

  macos-x86-wheel:
    name: Build macOS x84_64 wheels
    runs-on: macos-13
    outputs:
      job-status: ${{ job.status }}

    strategy:
      matrix:
        py: ["38", "39", "310", "311", "312"]
        deployment_target: ["11.0"]
      fail-fast: true

    env:
      MACOSX_DEPLOYMENT_TARGET: ${{ matrix.deployment_target }}

    steps:
      - uses: actions/checkout@v3
        name: Checkout the repository
        with:
          ref: ${{ github.event.inputs.incoming_ref }}

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.16.2
        env:
          CIBW_ARCHS_MACOS: x86_64
          CIBW_BUILD: cp${{ matrix.py }}-*
          CIBW_ENVIRONMENT: "WORKSPACE=${{ github.workspace }}"

      - name: Archive the built wheels
        uses: actions/upload-artifact@v4
        with:
          path: ./wheelhouse/*.whl
          name: wheels

  linux-wheel:
    name: Build linux wheels
    runs-on: ubuntu-latest
    outputs:
      job-status: ${{ job.status }}

    strategy:
      matrix:
        py: ["38", "39", "310", "311", "312"]
        arch: ["x86_64"]
        libc: ["many"]
      fail-fast: true

    steps:
      - name: Install Python library
        run: |
          apt install -y python3.8-dev python3.9-dev python3.10-dev python3.11-dev python3.12-dev
      - uses: actions/checkout@v3
        name: Checkout the repository
        with:
          ref: ${{ github.event.inputs.incoming_ref }}

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.16.2
        env:
          CIBW_BUILD: cp${{ matrix.py }}-${{ matrix.libc }}linux*
          CIBW_ARCHS: ${{ matrix.arch }}
          CIBW_ENVIRONMENT: "WORKSPACE=${{ github.workspace }}"

      - name: Archive the built wheels
        uses: actions/upload-artifact@v4
        with:
          path: ./wheelhouse/*.whl
          name: wheels

  publish-files-to-pypi:
    name: Publish distribution files to PyPI
    runs-on: ubuntu-22.04

    outputs:
      job-status: ${{ job.status }}

    needs:
      - "macos-arm-wheel"
      - "macos-x86-wheel"
      - "linux-wheel"

    steps:
      - name: Download pre-built wheels
        uses: actions/download-artifact@v4
        with:
          path: dist/
          name: wheels
      - name: pypi-publish
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYDISORT_TOKEN }}
